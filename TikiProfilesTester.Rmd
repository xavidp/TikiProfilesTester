---
title: "TikiProfilesTester"
author: "Xavier de Pedro Puente"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r install and load required packages, echo=FALSE}
source("http://bioconductor.org/biocLite.R")
#    biocLite("Rgraphviz")
#install.packages("GUIProfiler")
#install.packages("readr") # you only need to do this one time on your system
#install.packages("data.table")
#install.packages("R.utils")
#require(devtools)
#install_github('rCharts', 'ramnathv')
require(readr)
require(GUIProfiler)
require(data.table)
require(R.utils)
# Table file.path("results", format(Sys.Date(), "%y%m%d"),
#head(profilesResults)
if (!require("DT")) {
  # install from CRAN
  install.packages('DT', repos = 'http://cran.rstudio.com')
}
require('DT')
```

Example of output when the profile application failed:
root@penguinbookpro:/var/www/html/trunk# php console.php d:i --force;php console.php cache:clear --all;php console.php profile:apply Voting_System
Installation completed.
Queries executed successfully: 1392
Clearing all caches
Installation failed:
Applying profile: Voting_System
Preference set: feature_trackers=y
Preference set: feature_wiki_argvariable=y
Preference set: useGroupHome=y
Preference set: limitedGoGroupHome=y
Preference set: trackerfield_autoincrement=y
Preference set: trackerfield_dropdownother=y
Preference set: wikiplugin_jq=y
Preference set: instructions=Profile_Voting_System_voting_page
Added (or modified): tracker "Tracker for the Voting System"
Added (or modified): tracker_field "Note from the Voting System"
Added (or modified): tracker_field "Presidency"
Added (or modified): tracker_field "Vicepresidency"
Added (or modified): tracker_field "Secretarial"
Added (or modified): tracker_field "Treasury"
Added (or modified): tracker_field "Extra Membership 1"
Added (or modified): tracker_field "Extra Membership 2"
Added (or modified): tracker_field "Extra Membership 3"
Added (or modified): tracker_field "Extra Membership 4"
Added (or modified): tracker_field "Username"
Added (or modified): tracker_field "Vote #"
An error occurred: Cannot add user user1 to nonexistent group Group1
root@penguinbookpro:/var/www/html/trunk# 


```{r run command to test another profile}
output <- list()
output.splitted <- list()
outputFilename <- ""
error <- list()
notices <- list()
warnings <- list()
stricstd <- list()
error.idx <- list()

notices.idx <- ""
warnings.idx <- ""
stricstd.idx <- ""
N.Errors <- ""
N.Notices <- ""
N.Warnings <- ""
N.StrictsStd <- ""
Version <- ""
Revision <- ""
N <- ""
profilesResults <- ""
profilesResults.all <- list()
Versions <- c("12.x", "14.x", "trunk")
# make log folder if missing
if (!dir.exists(file.path(getwd(), "log", format(Sys.Date(), "%y%m%d")))) {
  dir.create(file.path(getwd(), "log", format(Sys.Date(), "%y%m%d")), recursive=T)
}
if (!dir.exists(file.path(getwd(), "results", format(Sys.Date(), "%y%m%d")))) {
  dir.create(file.path(getwd(), "results", format(Sys.Date(), "%y%m%d")), recursive=T)
}
profilesList <- fread("Tiki12_Profiles_List.csv", stringsAsFactors=FALSE, data.table=FALSE) 

#RRprofStart()
for (vv in 1:length(Versions)) {
  
  cat(paste0("\n* Version: ", Versions[vv], " -------------------------------------- \n"))
  Revision <- system(paste0("cd /var/www/html/", Versions[vv],";svn info | grep Revision"), intern=TRUE)
  Revision <- sub("Revision: ", "r", Revision, fixed=T)

  profilesResults <- cbind(Version, 
                         Revision, 
                         N, 
                         profilesList["ProfileCategory"],
                         profilesList[paste0("ProfileName_", Versions[vv])],
                         N.Errors,
                         N.Notices,
                         N.Warnings,
                         N.StrictsStd,
                         stringsAsFactors=FALSE
                         ) 
  
  for (ii in 1:dim(profilesList)[1]) { # ii counter of profile ID number
#    for (ii in 1:2) {
    #vv <- 1;ii <- 1;
  cat(paste0("** Profile (", ii, "/", dim(profilesList)[1],"): ", profilesList[ii,paste0("ProfileName_", Versions[vv])], "\n"))
  
    # read all profile
    outputFilename[ii] <- paste0(Versions[vv], "_", format(Sys.Date(), "%y%m%d"), "_p", sprintf("%02d", ii), "_output_", profilesList[ii,paste0("ProfileName_", Versions[vv])], ".txt")
      command <- paste0("cd /var/www/html/", Versions[vv], "/;php console.php d:i --force > \"", file.path(getwd(), "log", format(Sys.Date(), "%y%m%d"), outputFilename[ii]), "\" 2>&1 ;php console.php cache:clear --all >> \"", file.path(getwd(), "log", format(Sys.Date(), "%y%m%d"), outputFilename[ii]), "\" 2>&1;php console.php profile:apply ", profilesList[ii,paste0("ProfileName_", Versions[vv])], " >> \"", file.path(getwd(), "log", format(Sys.Date(), "%y%m%d"), outputFilename[ii]), "\" 2>&1")
      system(command)  
    output[[ii]] <- read_file(file.path(getwd(), "log", format(Sys.Date(), "%y%m%d"), outputFilename[ii]))
    output.splitted[[ii]] <- splitByPattern(output[[ii]], "\n")
    error.idx[[ii]] <- grep("error", output.splitted[[ii]], fixed=TRUE, value=F)
    error[[ii]] <- output.splitted[[ii]][ error.idx[[ii]] ]
    # Display errors in the R console output at least
    cat(error[[ii]])
    notices.idx  <- grep("Notice", output.splitted[[ii]], fixed=TRUE, value=F)
    notices[[ii]] <- output.splitted[[ii]][notices.idx]
    warnings.idx  <- grep("Warning", output.splitted[[ii]], fixed=TRUE, value=F)
    warnings[[ii]] <- output.splitted[[ii]][warnings.idx]
    stricstd.idx  <- grep("Strict Standards", output.splitted[[ii]], fixed=TRUE, value=F)
    stricstd[[ii]] <- output.splitted[[ii]][stricstd.idx]
    profilesResults[ii,] <- c(Versions[vv], 
                               Revision, 
                               sprintf("%02d", ii),
                               profilesList[ii,1],
                               profilesList[ii, paste0("ProfileName_", Versions[vv])],
                               length(error[[ii]]),
                               length(notices[[ii]]),
                               length(warnings[[ii]]),
                               length(stricstd[[ii]])
                              )
        if (length(error[[ii]]) > 0) {
              cat(error[[ii]], file=file.path(getwd(), "results", format(Sys.Date(), "%y%m%d"), paste0("errors_", Versions[vv], "_p", sprintf("%02d", ii),"__", profilesList[ii,paste0("ProfileName_", Versions[vv])],".txt")))
        }

    } # end of ii loop (profile ID)
  
    write.csv(profilesResults, file.path(getwd(), "results", format(Sys.Date(), "%y%m%d"), paste0("results_", Versions[vv], ".csv")), row.names=F)
  
} # end of loop for Tiki version
#RRprofStop()
# Uncomment to open the report
#RRprofReport()

```

Check the output produced.

```{r output, echo=TRUE}
results.files <- list.files(file.path(getwd(), "results", format(Sys.Date(), "%y%m%d")), pattern="results", ignore.case=T)
if (length(results.files) > 0 ) {
  for (ff in 1:length(results.files)) {
    profilesResults.all[[ff]] <- fread(file.path(getwd(), "results", format(Sys.Date(), "%y%m%d"), results.files[ff])) 
    p.r <- rbindlist(profilesResults.all, use.names=T, fill=FALSE, idcol=NULL)
    p.e <- subset(as.data.frame(p.r), N.Errors > 0)
    p.n <- subset(as.data.frame(p.r), N.Notices > 0)
    p.w <- subset(as.data.frame(p.r), N.Warnings > 0)
    p.s <- subset(as.data.frame(p.r), N.StrictsStd > 0)
    head(p.r)
    p.e
    p.n
    p.w
    p.s

#     require(tidyr)
#     p.r.t <- p.r %>% tidyr::gather(Issue, Freq, N.Errors:N.StrictsStd, na.rm = T)
#     p.r.t
    
# Some bar chart
require(rCharts)
profilesResults.all <- list()
    n1 <- nPlot(N.Errors ~ N, group = "Version", data = p.r, type = "multiBarChart")
    n1$chart(reduceXTicks = F)
    n1$xAxis(staggerLabels = F)
    n1$xAxis(rotateLabels=-90)
    n1$save(file.path(getwd(), "results", format(Sys.Date(), "%y%m%d"), "error_chart.html"), cdn = F)

p.r$N <- as.numeric(p.r$N)
p.r$N.Errors <- as.numeric(p.r$N.Errors)
p.r$N.Notices <- as.numeric(p.r$N.Notices)
p.r$N.Warnings <- as.numeric(p.r$N.Warnings)
p.r$N.StrictsStd <- as.numeric(p.r$N.StrictsStd)
require(DT)
    d = data.frame(
      p.r,
      stringsAsFactors = FALSE
    )
    dt <- datatable(d, filter = 'bottom', options = list(pageLength = 10)) %>%
    formatStyle('N.Errors',  
                color = styleInterval(c(0.5, 10), c('black', 'red', 'blue')),
                backgroundColor = styleInterval(0.5, c('white', 'yellow')),
                fontWeight = styleInterval(0.5, c('italics', 'bold'))) %>%
    formatStyle('N.Notices',  
                color = styleInterval(c(2, 5, 10), c('blue', 'red', 'green', 'brown')),
                backgroundColor = styleInterval(c(2, 5, 25), c('white', 'snow', 'lightyellow', 'lightgrey'))) %>%
    formatStyle('N.Warnings',
                background = styleColorBar(p.r$N.Warnings, 'steelblue'),
                backgroundSize = '100% 90%',
                backgroundRepeat = 'no-repeat',
                backgroundPosition = 'center'  ) %>%
    formatStyle('N.StrictsStd',  
                color = styleInterval(c(2, 5, 10), c('blue', 'red', 'green', 'brown')),
                backgroundColor = styleInterval(c(2, 5, 25), c('white', 'lightgreen', 'green', 'lightgrey')))

 
    saveWidget(dt, file.path(getwd(), "results", format(Sys.Date(), "%y%m%d"),'error_summary.html'))

  # Save Rda to disk
  my.rda.file <- paste0("my.rda")
  save(profilesResults.all,
     file=my.rda.file)

  }
  
}

# Pending
# GoogleVis chart?
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
